<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Authenticated Upload Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: auto; line-height: 1.6; }
        h1, h2 { border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        input, button { font-size: 1rem; padding: 0.5rem; margin-top: 0.5rem; width: 100%; box-sizing: border-box; }
        button { background-color: #333; color: white; border: none; cursor: pointer; }
        button:disabled { background-color: #999; cursor: not-allowed; }
        #status { margin-top: 1rem; padding: 1rem; border-radius: 5px; background-color: #f0f0f0; word-wrap: break-word; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        hr { margin: 2rem 0; }
    </style>
</head>
<body>

    <h1>Supabase Authenticated Upload Test</h1>
    <p>This script first logs you in as a test user, then uses that user's session to upload a file directly to Supabase Storage, respecting your RLS policies.</p>

    <!-- STEP 1: ADD YOUR SUPABASE CREDENTIALS HERE -->
    <p><strong>Important:</strong> You must edit this file and enter your Supabase URL and Anon Key below.</p>

    <hr>

    <h2>1. Login First</h2>
    <form id="login-form">
        <input type="email" id="email-input" placeholder="Enter test user email" required autocomplete="email" />
        <input type="password" id="password-input" placeholder="Enter password" required autocomplete="current-password" />
        <button type="submit">Log In</button>
    </form>
    <p id="auth-status"><strong>Status:</strong> Not logged in.</p>

    <hr>
    
    <h2>2. Upload File</h2>
    <input type="file" id="file-input" />
    <button id="upload-button">Upload File</button>

    <div id="status">
        <p>Status: Waiting for action...</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://lvpqojnsubocmalkaygb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cHFvam5zdWJvY21hbGtheWdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NTMxNzEsImV4cCI6MjA2NjUyOTE3MX0.LLhmlPJWDZGy7_ajaPsYHoXHXCpwbEILd5SLR0AwNAI';
        const BUCKET_NAME = 'user-uploads'; 

        // --- HTML ELEMENTS ---
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const statusDiv = document.getElementById('status');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authStatus = document.getElementById('auth-status');
        
        // --- INITIALIZE ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            
            updateStatus('info', 'Logging in...');
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                authStatus.innerHTML = '<strong>Status:</strong> Login failed.';
                updateStatus('error', `Login failed: ${error.message}`);
                return;
            }

            if (data.user) {
                authStatus.innerHTML = `<strong>Status:</strong> Logged in as: ${data.user.email}`;
                updateStatus('success', 'Login successful! You can now upload a file.');
            }
        });

        uploadButton.addEventListener('click', async () => {
            if (SUPABASE_URL.includes('YOUR_SUPABASE_URL')) {
                updateStatus('error', '<strong>Error:</strong> Please edit the HTML file and add your Supabase URL and Anon Key.');
                return;
            }

            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                updateStatus('error', 'You must log in first to upload a file.');
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                updateStatus('error', 'Please select a file first.');
                return;
            }
            
            // Use the authenticated user's ID for the file path, as required by your RLS policy
            const filePath = `${user.id}/${Date.now()}_${file.name}`;
            
            updateStatus('info', `Uploading to path: <strong>${filePath}</strong><br>File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)...`);
            uploadButton.disabled = true;

            try {
                const { data, error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, file);

                if (error) { throw error; }

                if (data) {
                    const successMessage = `
                        <strong>✅ Upload Successful!</strong><br>
                        <strong>Returned Path:</strong> ${data.path}
                    `;
                    updateStatus('success', successMessage);
                }
                
            } catch (error) {
                const errorMessage = `
                    <strong>❌ Upload Failed!</strong><br>
                    <strong>Error:</strong> ${error.message}
                `;
                updateStatus('error', errorMessage);
            } finally {
                uploadButton.disabled = false;
            }
        });

        function updateStatus(type, message) {
            statusDiv.className = type;
            statusDiv.innerHTML = `<p>${message}</p>`;
        }
    </script>

</body>
</html>