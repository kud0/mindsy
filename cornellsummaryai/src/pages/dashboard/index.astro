---
import Layout from '@/layouts/ModernDashboardLayout.astro';
import DashboardOverview from '@/components/dashboard/DashboardOverview';
import { requireAuth, createClient } from '@/lib/supabase-server';

const { user, response } = await requireAuth(Astro.cookies);
if (response) return response;

const supabase = createClient(Astro.cookies);

// Fetch user stats  
const { data: userData, error: userError } = await supabase
  .from('profiles')
  .select('full_name, subscription_tier')
  .eq('id', user.id)
  .single();

// Debug the database query
console.log('Dashboard Index - DB Query Error:', userError);
console.log('Dashboard Index - Raw userData from DB:', userData);

const { data: notesData } = await supabase
  .from('notes')
  .select('id')
  .eq('user_id', user.id);

const { data: studyNodesData } = await supabase
  .from('study_nodes')
  .select('id')
  .eq('user_id', user.id);

const stats = {
  totalNotes: notesData?.length || 0,
  totalStudyNodes: studyNodesData?.length || 0,
  userName: userData?.full_name || user.email?.split('@')[0] || 'User',
  subscriptionTier: userData?.subscription_tier || 'free'
};

// Debug: Log what we're fetching and passing
console.log('Dashboard Index - User data from DB:', userData);
console.log('Dashboard Index - Stats being passed:', stats);

const title = 'Dashboard';
const description = 'Your learning hub overview';
---

<Layout title={title} description={description}>
  <DashboardOverview 
    client:load 
    userName={stats.userName}
    totalNotes={stats.totalNotes}
    totalStudyNodes={stats.totalStudyNodes}
    subscriptionTier={stats.subscriptionTier}
  />
</Layout>